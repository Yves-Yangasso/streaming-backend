generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  password      String
  name          String?
  avatar        String?        // URL S3 pour avatar
  roleId        Int
  role          Role           @relation(fields: [roleId], references: [id])
  videos        Video[]
  subscriptions Subscription[]
  comments      Comment[]
  likes         Like[]
  createdAt     DateTime       @default(now())
}

model Role {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  privileges  Privilege[] // Relation many-to-many avec Privilege
  users       User[]
  createdAt   DateTime    @default(now())
}

model Privilege {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  roles     Role[]  // Relation many-to-many avec Role
  createdAt DateTime @default(now())
}

model Video {
  id             Int       @id @default(autoincrement())
  title          String
  description    String?
  url            String    // URL S3 pour la vidéo principale (ou playlist HLS si parts)
  thumbnail      String?   // URL miniature
  image_affiche  String?   // URL image d'affiche (poster ou featured image)
  duration       Int?      // Durée totale en secondes (somme des parts ?)
  typeId         Int
  type           VideoType @relation(fields: [typeId], references: [id])
  genres         Genre[]   // Relation many-to-many avec Genre
  parts          Part[]    // Une vidéo a plusieurs parties
  userId         Int
  user           User      @relation(fields: [userId], references: [id])
  comments       Comment[]
  likes          Like[]
  createdAt      DateTime  @default(now())
  views          Int       @default(0)
}

model VideoType {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  videos    Video[]
  createdAt DateTime @default(now())
}

model Genre {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  videos    Video[] // Relation many-to-many avec Video
  createdAt DateTime @default(now())
}

model Part {
  id        Int      @id @default(autoincrement())
  title     String?
  url       String   // URL S3 pour cette partie (segment vidéo)
  isPaid    Boolean  @default(false) // Gratuite ou payante
  duration  Int?     // Durée de cette partie en secondes
  order     Int?     // Ordre de la partie (pour séquencement)
  videoId   Int
  video     Video    @relation(fields: [videoId], references: [id])
  createdAt DateTime @default(now())
}

model Subscription {
  id        Int      @id @default(autoincrement())
  plan      String   // Ex: "basic", "premium" (ou référence à un modèle Plan si plus complexe)
  startDate DateTime
  endDate   DateTime?
  status    String   @default("active") // active, expired, cancelled, etc.
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  videoId   Int
  video     Video    @relation(fields: [videoId], references: [id])
  parentId  Int?     // Pour replies (optionnel, self-relation)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now())
  @@index([videoId])
  @@index([userId])
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  videoId   Int
  video     Video    @relation(fields: [videoId], references: [id])
  createdAt DateTime @default(now())
  @@unique([userId, videoId])  // Un user like une vidéo une fois
  @@index([videoId])
}